# Temporal Dotnet Source Generators

This repository contains a few experimental source generators for the temporal-dotnet SDK

## Contents

- [Getting Started](#getting-started)
- [Use Cases](#use-cases)
  - [1. Workflow extension methods](#1-workflow-extension-methods)
  - [2. Activity methods](#2-activity-methods)
  - [3. Activity mocks](#3-activity-mocks)
- [Debugging the code generators](#debugging-the-code-generators)
- [What does the generated code look like?](#what-does-the-generated-code-look-like)

## Getting Started

> TODO

## Use Cases:

### 1. Workflow extension methods

Creates a set of extension methods on the ITemporalClient for all classes marked with a [GenerateWorkflowExtension] attribute.

> TODO clarify whether this avoids issues with expression tree compilation

Usage:

Add GenerateWorkflowExtension attribute to Workflow:

```csharp
[Workflow]
[GenerateWorkflowExtension]
public class MyWorkflow
{
    [WorkflowRun]
    public Task RunAsync(string input)
    {
        return Task.CompletedTask;
    }
}
```

Invoke workflow from client:

```csharp
var client = new TemporalClient(...);
var result = client.ExecuteMyWorkflowAsync("input", options);
```

### 2. Activity methods

Creates a set of static methods on an Activities class for all classes marked with a [GenerateActivityExtension] attribute.

> TODO clarify whether this avoids issues with expression tree compilation

Usage:

Add GenerateActivityExtension attribute to Activity:

```csharp
[Activity]
[GenerateActivityExtension]
public async string MyActivity(string input)
{
    return "hello";
}
```

Invoke from Workflow:

```csharp
[WorkflowRun]
public async Task RunAsync()
{
    var result = await Activities.ExecuteMyActivity("input", options);
}
```

### 3. Activity mocks

Creates test doubles for activity classes. All methods marked with an [Activity] attribute will be mocked using NSubstitue meaning the mock behaviour can be configured from test execution. This is helpful when testing workflows with lots of activity executions or where we want to verify our activity delegates have been invoked.

Usage:

Create a partial class inheriting from `ActivityMockBase` and mark it with the [GenerateNSubstituteMocks] attribute. This will generate a partial class with a mock for each activity method.

```csharp
[GenerateNSubstituteMocks]
public partial class TestMocks : ActivityMockBase<TestActivities>
{
}

public class TestActivities
{
    [Activity]
    public Task<string> RunAsync()
    {
        return Task.FromResult("hello");
    }
}
```

From test instantiate the class and configure the mock behaviour using the NSubstitute syntax.

e.g. We can configure the activity RunAsync to return the string "goodbye" when invoked:

```csharp
[Fact]
public async Task Test1()
{
    // arrange
    var activities = new TestMocks();
    activities.MockRunAsync().Returns(Task.FromResult("goodbye"));

    // act
    var result = await activities.RunAsync();

    // assert
    Assert.Equal("goodbye", result);
}
```

The test above isn't very useful as we're just asserting the NSubstitute behaviour, but we can use this to test workflows and verify that our activity delegates have been invoked.

## Debugging the code generators

Each source generator has a launch profile with a sample project to debug the generators. The sample projects are located in the src/Samples folder.

## What does the generated code look like?

### Workflow Extension Methods:

```csharp
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System.Threading.Tasks;
using Generator.Tests.WorkflowGenerator;
using Temporalio.Client;
using Temporalio.Workflows;

namespace Temporalio.Generators.Workflows
{
    public static partial class TemporalClientExtensions
    {
        public static Task ExecuteTestWorkflowAsync(this ITemporalClient client, WorkflowOptions options)
        {
            return client.ExecuteWorkflowAsync((TestWorkflow wf) => wf.RunAsync(), options);
        }

        public static Task<WorkflowHandle<TestWorkflow>> StartTestWorkflowAsync(this ITemporalClient client, WorkflowOptions options)
        {
            return client.StartWorkflowAsync((TestWorkflow wf) => wf.RunAsync(), options);
        }
    }
}
```

### Activity Methods:

```csharp
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using Generator.Tests.ActivityGenerator;
using Temporalio.Client;
using Temporalio.Workflows;

namespace Temporalio.Generators.Activities
{
    public static partial class Activities
    {
        public static System.Threading.Tasks.Task ExecuteRunMethod(Generator.Tests.ActivityGenerator.TestRecord input, string input2, ActivityOptions options)
        {
            return Workflow.ExecuteActivityAsync(() => Generator.Tests.ActivityGenerator.TestActivities.RunMethod(input, input2), options);
        }
    }
}
```

### Activity Mocks:

```csharp
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using NSubstitute;
using Temporalio.Activities;

namespace Generator.Tests.ActivityMockGenerator
{
    public partial class TestMocks
    {
        public Func<Task<string>> MockRunAsync = Substitute.For<Func<Task<string>>>();

        [Activity]
        public Task<string> RunAsync()
        {
            return MockRunAsync();
        }
    }
}
```
